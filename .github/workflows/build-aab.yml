name: Build AAB for Manual Upload

on:
  workflow_dispatch: # Manual triggering only from GitHub UI
    inputs:
      version_name:
        description: 'Version name (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      version_code:
        description: 'Version code (must be unique and increment)'
        required: true
        default: '5'

permissions:
  contents: write

jobs:
  build-aab:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        
    - name: Update Version Info
      run: |
        sed -i 's/versionCode = .*/versionCode = ${{ github.event.inputs.version_code }}/' mpt-android/app/build.gradle.kts
        sed -i 's/versionName = .*/versionName = "${{ github.event.inputs.version_name }}"/' mpt-android/app/build.gradle.kts
        
    - name: Decode Keystore
      env:
        ENCODED_STRING: ${{ secrets.SIGNING_KEYSTORE_BASE64 }}
      run: |
        mkdir -p mpt-android/app/keystore
        echo $ENCODED_STRING | base64 -di > mpt-android/app/keystore/mpt-keystore
        
    - name: Build AAB
      env:
        KEYSTORE_PATH: "keystore/mpt-keystore"
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        cd mpt-android
        ./gradlew clean
        ./gradlew bundleRelease
        
    - name: Prepare AAB for Download
      run: |
        mkdir -p deploy
        cp mpt-android/app/build/outputs/bundle/release/app-release.aab deploy/tafels-oefenen-${{ github.event.inputs.version_name }}.aab
        
    - name: Upload AAB as GitHub Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tafels-oefenen-aab
        path: deploy/tafels-oefenen-${{ github.event.inputs.version_name }}.aab
        retention-days: 30
        
    - name: Upload Mapping File
      uses: actions/upload-artifact@v4
      with:
        name: mapping-file
        path: mpt-android/app/build/outputs/mapping/release/mapping.txt
        retention-days: 30
        
    - name: Display Download Instructions
      run: |
        echo "ðŸŽ‰ AAB file built successfully!"
        echo ""
        echo "ðŸ“¥ Download the AAB file:"
        echo "1. Go to Actions tab â†’ Select this workflow run"
        echo "2. Click on 'tafels-oefenen-aab' artifact"
        echo "3. Download 'tafels-oefenen-${{ github.event.inputs.version_name }}.aab'"
        echo ""
        echo "ðŸ“‹ Upload to Google Play Console:"
        echo "1. Go to Google Play Console â†’ Your app"
        echo "2. Release â†’ Manage release â†’ Create new release"
        echo "3. Upload the downloaded AAB file"
        echo ""
        echo "ðŸ”‘ This AAB is signed with the same key as your CI/CD pipeline"
